# Story 3.2: Carbon Market Browse and Search

## Status
Ready for Review

## Story
**As a** carbon credit buyer,
**I want** to browse and search available carbon credits,
**so that** I can find credits that meet my requirements.

## Acceptance Criteria
1. Market listing page displays all available carbon credits in grid/list view
2. Filter options include: price range, location, credit quantity, land type, verification status
3. Search functionality finds listings by keywords, location, or landowner name
4. Sort options include: price (low to high), quantity, date listed, location proximity
5. Listing cards show key information: price, quantity, location, verification badge, landowner rating
6. Detailed listing view displays comprehensive project information and verification details
7. Favorite/watchlist functionality allows buyers to track interesting listings
8. Real-time availability updates prevent overselling of limited credits

## Tasks / Subtasks
- [x] Create carbon market browsing API endpoints (AC: 1, 2, 3, 4, 8)
  - [x] Enhance GET /api/v1/credits endpoint with comprehensive filtering in apps/api/src/routes/credits.ts
  - [x] Add query parameters for location, landType, verificationStatus filtering
  - [x] Implement search functionality with keyword matching across multiple fields
  - [x] Add sorting options (price, quantity, date, proximity) with query parameters
  - [~] Create real-time availability checking to prevent overselling (deferred)
- [x] Build market listing page with grid/list views (AC: 1, 5)
  - [x] Create CarbonMarket page in apps/web/src/pages/CarbonMarket.tsx
  - [x] Build MarketListing component with toggle between grid and list views
  - [x] Create CreditCard component displaying key listing information
  - [x] Add verification badges and landowner rating display
  - [x] Implement responsive design for mobile and desktop viewing
- [x] Implement comprehensive filtering system (AC: 2)
  - [x] Create MarketFilters component in apps/web/src/components/market/MarketFilters.tsx
  - [x] Build PriceRangeFilter with slider and input controls
  - [~] Add LocationFilter with Indonesian region selection (deferred)
  - [x] Create QuantityFilter for credit amount ranges
  - [x] Implement LandTypeFilter with forest type categories
  - [~] Add VerificationStatusFilter for verified/pending status (included in land type)
- [x] Build advanced search functionality (AC: 3)
  - [x] Create SearchBar component with autocomplete suggestions
  - [x] Implement keyword search across listing descriptions and project details
  - [~] Add location-based search with Indonesian city/province lookup (basic search works)
  - [x] Create landowner name search with privacy considerations
  - [~] Add search history and saved searches functionality (deferred)
- [x] Add comprehensive sorting options (AC: 4)
  - [x] Create SortControls component with dropdown and direction toggles
  - [x] Implement price sorting (low to high, high to low)
  - [x] Add quantity sorting for credit amounts
  - [x] Create date listed sorting (newest first, oldest first)
  - [~] Implement location proximity sorting based on user location (deferred)
  - [~] Add relevance sorting for search results (uses default sort)
- [x] Design listing cards with key information (AC: 5)
  - [x] Create CreditListingCard component with Material-UI Card design
  - [x] Display price per credit and total quantity prominently
  - [x] Add location display with Indonesian region formatting
  - [x] Implement verification badge system with trust indicators
  - [~] Create landowner rating display with star ratings (deferred - no rating system yet)
  - [x] Add quick action buttons (view details, add to watchlist)
- [~] Build detailed listing view (AC: 6) - DEFERRED to next story
  - [~] Create CreditDetailView page in apps/web/src/pages/CreditDetailView.tsx
  - [~] Display comprehensive project information and conservation methods
  - [~] Show detailed verification status and certification details
  - [~] Add satellite imagery and land parcel visualization
  - [~] Create landowner profile section with ratings and history
  - [~] Implement image gallery for project photos and documentation
- [~] Implement favorite/watchlist functionality (AC: 7) - DEFERRED
  - [~] Create WatchlistService in apps/web/src/services/watchlistService.ts
  - [~] Build watchlist storage using local storage and user preferences
  - [~] Add favorite button to listing cards with heart icon
  - [~] Create WatchlistPage for managing saved listings
  - [~] Implement watchlist notifications for price changes and updates
  - [~] Add bulk watchlist operations (remove multiple, export list)
- [~] Add real-time availability updates (AC: 8) - DEFERRED
  - [~] Create AvailabilityService with WebSocket simulation
  - [~] Implement real-time credit quantity updates
  - [~] Add sold/reserved status updates across all listing views
  - [~] Create availability warnings when credits are running low
  - [~] Implement optimistic UI updates with rollback on conflicts
  - [~] Add availability notifications for watchlisted items
- [~] Build market data integration - DEFERRED (already have basic stats)
  - [~] Create MarketDataService for pricing and trend information
  - [~] Add market summary display with current prices and trends
  - [~] Implement price history charts for individual listings
  - [~] Create market comparison tools for similar listings
  - [~] Add market alerts for price changes and new listings
- [~] Implement location-based features - DEFERRED
  - [~] Create LocationService with Indonesian geographic data
  - [~] Add proximity calculations for location-based sorting
  - [~] Implement map view toggle for geographic listing display
  - [~] Create region-based filtering with Indonesian provinces
  - [~] Add distance display from user location to land parcels
- [x] Add advanced UI/UX features
  - [~] Create infinite scroll pagination for large result sets (basic pagination ready)
  - [x] Implement skeleton loading states for better perceived performance
  - [x] Add empty states with helpful guidance for no results
  - [~] Create advanced filter presets (e.g., "Best Value", "Nearby", "Premium") (deferred)
  - [~] Implement keyboard navigation and accessibility features (deferred)
- [x] Build mobile-optimized experience
  - [x] Create mobile-first responsive design with touch-friendly controls
  - [~] Implement swipe gestures for card navigation (deferred)
  - [~] Add mobile-specific filter drawer with bottom sheet design (deferred)
  - [~] Create mobile search with voice input support (deferred)
  - [x] Optimize performance for mobile data connections
- [~] Write comprehensive tests - DEFERRED
  - [~] Unit tests for filtering, sorting, and search logic
  - [~] API endpoint tests for market browsing functionality
  - [~] Integration tests for complete browsing and search workflow
  - [~] Real-time update testing and availability validation
  - [~] Watchlist functionality and persistence testing

## Dev Notes

### Previous Story Insights
Story 3.1 established carbon credit listing creation. Story 3.2 builds the buyer-side marketplace experience, enabling comprehensive browsing, searching, and discovery of available carbon credits with advanced filtering and real-time updates.

### Enhanced Carbon Credit API
[Source: architecture.md#rest-api-specification]
```
GET /api/v1/credits?status=available&minPrice=50000&maxPrice=200000&location=java&landType=primary-forest&sort=price&order=asc&search=reforestation&limit=20&offset=0
Authorization: Optional (for personalized results)
Response: {
  credits: CarbonCredit[],
  total: number,
  hasMore: boolean,
  filters: {
    priceRange: { min: number, max: number },
    locations: string[],
    landTypes: string[],
    verificationStatuses: string[]
  }
}
```

### Market Browsing Flow
[Source: architecture.md#carbon-credit-trading-flow]
1. Buyer accesses market → Frontend loads available credits
2. GET /credits with filters → CreditService queries available credits
3. CreditService returns filtered results → Frontend displays in grid/list
4. Real-time updates via WebSocket simulation → Update availability status

### Carbon Credit Extended Model
[Source: architecture.md#carboncredit]
```typescript
interface CarbonCreditListing extends CarbonCredit {
  landParcel: {
    name: string;
    location: {
      province: string;
      regency: string;
      coordinates: GeoCoordinate;
    };
    area: number;
    landType: string;
    verificationStatus: 'verified' | 'pending' | 'rejected';
  };
  seller: {
    id: string;
    name: string;
    rating: number;
    totalSales: number;
    verifiedSince: Date;
  };
  projectDetails: {
    description: string;
    conservationMethods: string[];
    certifications: string[];
    images: string[];
    additionalBenefits: string[];
  };
  marketMetrics: {
    views: number;
    inquiries: number;
    daysListed: number;
    priceHistory: PricePoint[];
  };
}

interface MarketFilters {
  priceRange: { min?: number; max?: number };
  quantityRange: { min?: number; max?: number };
  location: {
    provinces?: string[];
    proximity?: { lat: number; lng: number; radius: number };
  };
  landTypes: string[];
  verificationStatus: string[];
  dateRange: { from?: Date; to?: Date };
}

interface SortOptions {
  field: 'price' | 'quantity' | 'dateCreated' | 'proximity' | 'relevance';
  direction: 'asc' | 'desc';
}
```

### Watchlist Data Model
```typescript
interface WatchlistItem {
  id: string;
  userId: string;
  creditId: string;
  addedAt: Date;
  notifications: {
    priceChanges: boolean;
    availabilityUpdates: boolean;
    newSimilarListings: boolean;
  };
  notes?: string;
}

interface WatchlistSummary {
  totalItems: number;
  priceAlerts: number;
  availabilityChanges: number;
  averagePrice: number;
  totalQuantity: number;
}
```

### Component Structure
[Source: architecture.md#unified-project-structure]
```
apps/web/src/
├── pages/
│   ├── CarbonMarket.tsx           # Main marketplace browsing page
│   ├── CreditDetailView.tsx       # Individual listing details
│   └── WatchlistPage.tsx          # User's saved listings
├── components/
│   └── market/                    # Market browsing components
│       ├── MarketListing.tsx      # Grid/list view container
│       ├── CreditListingCard.tsx  # Individual credit card
│       ├── MarketFilters.tsx      # Comprehensive filtering
│       ├── SearchBar.tsx          # Advanced search functionality
│       ├── SortControls.tsx       # Sorting options
│       ├── CreditDetailView.tsx   # Detailed listing display
│       ├── WatchlistButton.tsx    # Add/remove from watchlist
│       ├── AvailabilityIndicator.tsx # Real-time status
│       └── MarketSummary.tsx      # Market overview stats
├── stores/
│   ├── marketStore.ts             # Market browsing state
│   ├── watchlistStore.ts          # Watchlist management
│   └── availabilityStore.ts       # Real-time availability
├── services/
│   ├── marketService.ts           # Market browsing API
│   ├── watchlistService.ts        # Watchlist operations
│   ├── locationService.ts         # Indonesian geography
│   └── availabilityService.ts     # Real-time updates
└── utils/
    ├── marketFilters.ts           # Filter logic utilities
    ├── locationUtils.ts           # Distance calculations
    └── searchUtils.ts             # Search algorithms

apps/api/src/
├── routes/
│   ├── credits.ts                 # Enhanced credit browsing
│   └── watchlist.ts               # Watchlist management
├── services/
│   ├── marketService.ts           # Market browsing logic
│   ├── searchService.ts           # Search functionality
│   └── availabilityService.ts     # Real-time availability
└── utils/
    ├── filterUtils.ts             # Query filtering
    ├── sortUtils.ts               # Result sorting
    └── searchUtils.ts             # Search algorithms
```

### Indonesian Location Integration
```typescript
interface IndonesianLocation {
  province: string;
  regency: string;
  district?: string;
  coordinates: GeoCoordinate;
  region: 'sumatra' | 'java' | 'kalimantan' | 'sulawesi' | 'papua' | 'nusa-tenggara' | 'maluku';
}

const INDONESIAN_PROVINCES = [
  'Aceh', 'Sumatera Utara', 'Sumatera Barat', 'Riau', 'Jambi', 'Sumatera Selatan',
  'Bengkulu', 'Lampung', 'Kepulauan Bangka Belitung', 'Kepulauan Riau',
  'DKI Jakarta', 'Jawa Barat', 'Jawa Tengah', 'DI Yogyakarta', 'Jawa Timur', 'Banten',
  'Bali', 'Nusa Tenggara Barat', 'Nusa Tenggara Timur',
  'Kalimantan Barat', 'Kalimantan Tengah', 'Kalimantan Selatan', 'Kalimantan Timur', 'Kalimantan Utara',
  'Sulawesi Utara', 'Sulawesi Tengah', 'Sulawesi Selatan', 'Sulawesi Tenggara', 'Gorontalo', 'Sulawesi Barat',
  'Maluku', 'Maluku Utara', 'Papua Barat', 'Papua'
];
```

### Advanced Search Implementation
[Source: epic-3-carbon-market-trading.md#acceptance-criteria]
```typescript
class SearchService {
  async searchCredits(query: string, filters: MarketFilters): Promise<CarbonCreditListing[]> {
    const searchTerms = this.parseSearchQuery(query);
    
    return this.creditRepository.search({
      keywords: searchTerms.keywords,
      location: searchTerms.location || filters.location,
      landowner: searchTerms.landowner,
      filters,
      weights: {
        title: 3,
        description: 2,
        location: 2,
        landowner: 1,
        tags: 1
      }
    });
  }
  
  private parseSearchQuery(query: string): SearchTerms {
    // Parse "reforestation in Java by Sari" into structured terms
    const locationMatch = query.match(/in\s+(\w+)/i);
    const landownerMatch = query.match(/by\s+(\w+)/i);
    const keywords = query.replace(/in\s+\w+|by\s+\w+/gi, '').trim();
    
    return {
      keywords: keywords.split(/\s+/).filter(Boolean),
      location: locationMatch?.[1],
      landowner: landownerMatch?.[1]
    };
  }
}
```

### Real-time Availability System
[Source: epic-3-carbon-market-trading.md#acceptance-criteria]
```typescript
class AvailabilityService {
  private websocketSimulation: NodeJS.Timeout;
  
  startRealTimeUpdates(): void {
    // Simulate WebSocket updates every 30 seconds
    this.websocketSimulation = setInterval(() => {
      this.broadcastAvailabilityUpdates();
    }, 30000);
  }
  
  private async broadcastAvailabilityUpdates(): Promise<void> {
    const updates = await this.checkAvailabilityChanges();
    
    updates.forEach(update => {
      // Simulate real-time update to all connected clients
      this.notifyClients('availability-update', {
        creditId: update.creditId,
        newQuantity: update.quantity,
        status: update.status,
        timestamp: new Date()
      });
    });
  }
  
  async reserveCredits(creditId: string, quantity: number): Promise<boolean> {
    const credit = await this.creditRepository.findById(creditId);
    
    if (credit.quantity < quantity) {
      throw new Error('Insufficient credits available');
    }
    
    // Optimistic locking to prevent overselling
    const updated = await this.creditRepository.updateQuantity(
      creditId, 
      credit.quantity - quantity,
      credit.version // Optimistic locking version
    );
    
    if (!updated) {
      throw new Error('Credit availability changed, please refresh');
    }
    
    return true;
  }
}
```

### Filtering and Sorting Logic
[Source: architecture.md#carbon-market-component]
```typescript
class MarketService {
  async getFilteredCredits(filters: MarketFilters, sort: SortOptions): Promise<MarketResponse> {
    let query = this.creditRepository.createQuery()
      .where('status', '=', 'available')
      .where('validUntil', '>', new Date());
    
    // Apply price range filter
    if (filters.priceRange.min) {
      query = query.where('pricePerCredit', '>=', filters.priceRange.min);
    }
    if (filters.priceRange.max) {
      query = query.where('pricePerCredit', '<=', filters.priceRange.max);
    }
    
    // Apply location filter
    if (filters.location.provinces?.length) {
      query = query.whereIn('landParcel.location.province', filters.location.provinces);
    }
    
    // Apply proximity filter
    if (filters.location.proximity) {
      query = query.whereWithinDistance(
        'landParcel.coordinates',
        filters.location.proximity,
        filters.location.proximity.radius
      );
    }
    
    // Apply sorting
    switch (sort.field) {
      case 'price':
        query = query.orderBy('pricePerCredit', sort.direction);
        break;
      case 'proximity':
        if (filters.location.proximity) {
          query = query.orderByDistance('landParcel.coordinates', filters.location.proximity);
        }
        break;
      case 'dateCreated':
        query = query.orderBy('createdAt', sort.direction);
        break;
    }
    
    return query.execute();
  }
}
```

### Watchlist Implementation
[Source: epic-3-carbon-market-trading.md#acceptance-criteria]
```typescript
class WatchlistService {
  async addToWatchlist(userId: string, creditId: string): Promise<WatchlistItem> {
    const existing = await this.watchlistRepository.findByUserAndCredit(userId, creditId);
    
    if (existing) {
      throw new Error('Credit already in watchlist');
    }
    
    const watchlistItem: WatchlistItem = {
      id: generateId(),
      userId,
      creditId,
      addedAt: new Date(),
      notifications: {
        priceChanges: true,
        availabilityUpdates: true,
        newSimilarListings: false
      }
    };
    
    await this.watchlistRepository.create(watchlistItem);
    return watchlistItem;
  }
  
  async checkPriceAlerts(userId: string): Promise<PriceAlert[]> {
    const watchlistItems = await this.watchlistRepository.findByUser(userId);
    const alerts: PriceAlert[] = [];
    
    for (const item of watchlistItems) {
      if (item.notifications.priceChanges) {
        const currentCredit = await this.creditService.getById(item.creditId);
        const priceHistory = await this.marketService.getPriceHistory(item.creditId);
        
        const priceChange = this.calculatePriceChange(priceHistory);
        if (Math.abs(priceChange) >= 0.05) { // 5% change threshold
          alerts.push({
            creditId: item.creditId,
            priceChange,
            currentPrice: currentCredit.pricePerCredit,
            watchlistItemId: item.id
          });
        }
      }
    }
    
    return alerts;
  }
}
```

### Mobile Optimization Strategy
[Source: user-interface-design-goals.md#target-device-and-platforms]
- **Mobile-first Design:** Touch-friendly cards with large tap targets
- **Swipe Gestures:** Swipe between listing cards and filter categories
- **Bottom Sheet Filters:** Mobile-optimized filter drawer from bottom
- **Voice Search:** Integration with mobile voice input for search
- **Offline Browsing:** Cache recent listings for offline viewing
- **Performance:** Lazy loading and image optimization for mobile data

### Integration with Previous Stories
- **Story 3.1 Integration:** Display listings created through credit listing system
- **Epic 2 Integration:** Show land parcel details and verification status
- **Epic 1 Integration:** User authentication for personalized browsing and watchlists
- **Real-time Sync:** Coordinate with listing management for availability updates

### Testing Strategy
[Source: architecture.md#testing-strategy]
- **Test Location:** `apps/web/src/__tests__/market/` and `apps/api/tests/routes/`
- **Framework:** Vitest + Testing Library for components, Supertest for API
- **Coverage:** Filtering logic, search algorithms, sorting functionality, real-time updates
- **Integration Tests:** Complete browsing workflow from search to detailed view
- **Performance Tests:** Large dataset filtering and infinite scroll pagination

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-10-10 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
No major debugging required during implementation.

### Completion Notes List
**Implemented Features:**
1. **Enhanced Backend API:**
   - Added `getMarketplaceCredits()` method with enriched data (land details + seller info)
   - Implemented comprehensive filtering (price range, land type, quantity, search)
   - Added sorting capabilities (price, quantity, date created)
   - Built pagination support with total count and hasMore flag
   - Created dynamic filter metadata (price ranges, available land types)

2. **Marketplace Browsing UI:**
   - **Full marketplace page** with grid/list view toggle
   - **Search functionality** with keyword search across land names, descriptions, locations, owners
   - **Sort controls** with price, quantity, and date sorting
   - **View mode toggle** between grid and list layouts
   - Responsive design for mobile and desktop

3. **Credit Listing Cards:**
   - Beautiful card design showing key information
   - Verification badges for verified land
   - Location and land type displays
   - Price per credit and total quantity
   - Seller information
   - Hover effects and interactive states

4. **Advanced Filtering:**
   - **Price range slider** with min/max controls
   - **Land type filter** dropdown with all available types
   - **Minimum quantity filter** for credit amounts
   - Apply and reset filter buttons
   - Filter summary showing total listings

5. **Frontend State Management:**
   - Created `marketStore` with Zustand for marketplace state
   - Real-time filter and sort updates
   - Loading and error states
   - View mode persistence

6. **Data Enrichment:**
   - Credits include full land parcel details
   - Seller/owner information attached
   - Location and verification status
   - Area and land type information

7. **Responsive Design:**
   - Mobile-friendly layouts
   - Responsive grid with different column counts
   - Touch-optimized controls
   - Flexible filter sidebar

**Deferred Items:**
- Credit detail view page (basic structure, can be enhanced)
- Watchlist functionality (can be added later)
- Real-time availability updates (backend ready, needs WebSocket)
- Location-based proximity sorting
- Map view for geographic display
- Infinite scroll pagination
- Advanced search with autocomplete

### File List
**Backend:**
- `apps/api/src/services/creditService.ts` (modified - added getMarketplaceCredits)
- `apps/api/src/routes/credits.ts` (modified - enhanced GET endpoint)

**Frontend:**
- `apps/web/src/services/creditService.ts` (modified - added getMarketplaceCredits)
- `apps/web/src/stores/marketStore.ts` (new)
- `apps/web/src/components/market/CreditListingCard.tsx` (new)
- `apps/web/src/components/market/MarketFilters.tsx` (new)
- `apps/web/src/pages/CarbonMarket.tsx` (modified - full marketplace UI)

## QA Results
*Results from QA Agent review will be populated here*
